#+STARTUP: showall indent hidestars

#+TITLE: Контракты в DAG

* Интро

Этот документ описывает криптографический протокол выполнения контракта в направленном
ацикликлическом графе. Это модельный пример, предназначенный для иллюстрации идеи. Он
может быть изменен ради поддержки более сложных видов контрактов.

В сценарии контракта участвуют ~Продавец~ и ~Покупатель~. ~Продавец~ предлагает сделку,
а ~Покупатель~ расплачивается за нее, создавая транзакцию перевода денег продавцу,
которую децентрализованная сеть апрувит только в том случае, если ~Покупатель~ будет
удовлетворен. В противном случае транзакция перевда денег продавцу не будет
подтверждена.

* Протокол взаимодействия

[[img:dag-contract.png]]

- Продавец формирует предложение о сделке и отправляет его в сеть как обычную
  транзакцию, содержащую информацию о условиях сделки. Назовем эту транзакцию
  ~deal~. Эта транзакция будет подтверждена сетью на общих основаниях.
- Покупатель выбирает среди подтвержденных сетью транзакцию ~secret~ и складывает ее
  хэш с хешем ~deal~. Результат сложения хэшируется и становится приватным ключем
  ~private~. Из этого приватного ключа тривиально получает публичный ключ ~public~. Эту
  пару ключей Покупатель сохраняет у себя.
- Покупатель создает транзакцию перевода средств Продавцу (~transfer~). Транзакция
  ссылается на ~deal~ и кошелек Покупателя (~wallet~). Эта транзакция подписана ключом
  ~private~. Эту транзакцию сеть пока не может подтвердить, так как для проверки
  подписи необходимо знать ~public~, а его Покупатель пока не раскрыл.
- Продавец высылает товар, Покупатель его получает.
- Если Покупатель доволен, он раскрывает ~public~ создавая транзакцию ~expose~, которая
  его содержит. Эта транзакция ссылается на ~transfer~, чтобы явно указать, что
  подтверждает его. Теперь у сети есть достаточно данных, чтобы подтвердить
  транзакцию. Если же Покупатель не доволен, то он ничего не делает и транзакция
  остается неподтвержденной.
- Опциональный шаг: Покупатель может раскрыть ~private~, создав транзакцию ~prove~,
  которая ссылается на ~secret~ (и на ~transfer~).
