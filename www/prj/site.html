<!DOCTYPE html>
<html>
<head>
<title>Как сделан сайт rigidus.ru</title>
<meta  charset="utf-8">
<meta  name="generator" content="Org-mode">
<meta  name="author" content="rigidus">
<link href="/css/style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="content">
<h1 class="title">Как сделан сайт rigidus.ru</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">О проекте</a></li>
<li><a href="#sec-2">Установка и настройка</a>
<ul>
<li><a href="#sec-2-1">Легкий старт</a></li>
<li><a href="#sec-2-2">Инструменты разработки</a></li>
</ul>
</li>
<li><a href="#sec-3">Как это работает</a></li>
<li><a href="#sec-4">Сборка</a>
<ul>
<li><a href="#sec-4-1">Файл определения системы</a></li>
<li><a href="#sec-4-2">Подготовка к запуску</a></li>
<li><a href="#sec-4-3">Определение пакетов</a></li>
<li><a href="#sec-4-4">Утилиты</a></li>
<li><a href="#sec-4-5">Copyright</a></li>
<li><a href="#sec-4-6">Определение модуля</a></li>
<li><a href="#sec-4-7">Инициализация</a></li>
</ul>
</li>
<li><a href="#sec-5">Трансляция путей</a></li>
<li><a href="#sec-6">Шаблон блоков статистики</a></li>
<li><a href="#sec-7">Html-tree</a>
<ul>
<li><a href="#sec-7-1">Парсинг html</a></li>
<li><a href="#sec-7-2">Сборка в html</a></li>
</ul>
</li>
<li><a href="#sec-8">Преобразование страниц</a></li>
<li><a href="#sec-9">Рендеринг</a></li>
<li><a href="#sec-10">Маршрутизация</a>
<ul>
<li><a href="#sec-10-1">Статические файлы</a></li>
<li><a href="#sec-10-2">404 страница</a></li>
<li><a href="#sec-10-3">Страница robots.txt</a></li>
<li><a href="#sec-10-4">Страницы orgmode</a></li>
<li><a href="#sec-10-5">Маршруты страниц</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">О проекте</a></li>
<li><a href="#sec-2">Установка и настройка</a>
<ul>
<li><a href="#sec-2-1">Легкий старт</a></li>
<li><a href="#sec-2-2">Инструменты разработки</a></li>
</ul>
</li>
<li><a href="#sec-3">Как это работает</a></li>
<li><a href="#sec-4">Сборка</a>
<ul>
<li><a href="#sec-4-1">Файл определения системы</a></li>
<li><a href="#sec-4-2">Подготовка к запуску</a></li>
<li><a href="#sec-4-3">Определение пакетов</a></li>
<li><a href="#sec-4-4">Утилиты</a></li>
<li><a href="#sec-4-5">Copyright</a></li>
<li><a href="#sec-4-6">Определение модуля</a></li>
<li><a href="#sec-4-7">Инициализация</a></li>
</ul>
</li>
<li><a href="#sec-5">Трансляция путей</a></li>
<li><a href="#sec-6">Шаблон блоков статистики</a></li>
<li><a href="#sec-7">Html-tree</a>
<ul>
<li><a href="#sec-7-1">Парсинг html</a></li>
<li><a href="#sec-7-2">Сборка в html</a></li>
</ul>
</li>
<li><a href="#sec-8">Преобразование страниц</a></li>
<li><a href="#sec-9">Рендеринг</a></li>
<li><a href="#sec-10">Маршрутизация</a>
<ul>
<li><a href="#sec-10-1">Статические файлы</a></li>
<li><a href="#sec-10-2">404 страница</a></li>
<li><a href="#sec-10-3">Страница robots.txt</a></li>
<li><a href="#sec-10-4">Страницы orgmode</a></li>
<li><a href="#sec-10-5">Маршруты страниц</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">О проекте</h2>
<div class="outline-text-2" id="text-1">
<p>
Я делал этот сайт, тренируясь в <a href="../doc/literate-programming.html">литературном программировании</a>.
Литературное программирование (Literate Programming) - методология
программирования и документирования, в которой программа состоит из
прозы на естественном языке вперемежку с макроподстановками и кодом на
языках программирования.
</p>

<p>
Он содержит в себе весь код, который обеспечивает работу сайта и
сделан максимально простым, чтобы служить наглядным введением в
<code>literate programming</code> с использованием <code>lisp</code> и набора инструментов,
реализованного в <code>emacs</code>: <code>org-mode</code>, <code>babel</code> и других.
</p>

<div class="note">
<p>
Вы можете пропустить раздел <b>Установка и настройка</b> и перейти сразу
к разделу <b><a href="#sec-3">Как это работает</a></b>, если вы не собираетесь использовать
эти инструменты прямо сейчас.
</p>

</div>

<p>
Документ ниже является литературным исходником сайта
<a href="http://rigidus.ru">http://rigidus.ru</a>.
</p>

<p>
Сам сайт был изначально создан для сбора редких и интересных
материалов о вычислительных моделях и языках программирования. Позже
он также превратился в занимательное упражнение в реализации
разнообразных программистких концепций.
</p>

<p>
Исходный код открыт по лицензии GNU v.3. Данные, в том числе
руководства и книги, могут иметь свои лицензии.
</p>

<p>
Репозиторий с исходным кодом и историей коммитов доступен на
<a href="https://github.com/rigidus/rigidus.ru">https://github.com/rigidus/rigidus.ru</a>
</p>

<p>
Вы можете делать любые дополнения и предложения в форме
<code>pull-requests</code> и <code>issue</code>.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Установка и настройка</h2>
<div class="outline-text-2" id="text-2">
<p>
Этот сайт работает внутри образа <code>Common Lisp</code> под управлением
веб-сервера <code>hunchentoot</code>. В качестве высокоуровневой библиотеки
используется <a href="https://github.com/archimag/restas">RESTAS</a>, которую написал Андрей Москвитин (archimag).
</p>

<p>
Веб-сервер, библиотеку и все необходимые зависимости лучше всего
установить при помощи менеджера библиотек <a href="http://quicklisp.org">Quicklisp</a>.
</p>

<p>
Чтобы просто запустить сайт и попробовать его в работе, пройдите
раздел "Легкий старт". Все что идет дальше потребуется вам чтобы
обеспечить инструментарий для литературного программирования.
</p>
</div>

<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1">Легкий старт</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Установите <code>git</code> - систему управления версиями, если она еще не
установлена:
</p>

<div class="org-src-container">

<pre class="src src-sh">sudo apt-get install git
</pre>
</div>

<p>
Клонируйте репозиторий проекта:
</p>

<div class="org-src-container">

<pre class="src src-sh">mkdir -p ~/repo
<span style="color: #483d8b;">cd</span> ~/repo
git clone git@github.com:rigidus/rigidus.ru.git
</pre>
</div>

<p>
Установите <code>sbcl</code> - реализацию Common Lisp
</p>

<div class="org-src-container">

<pre class="src src-sh">sudo apt-get install sbcl
</pre>
</div>

<p>
Установите quicklisp - менеджер библиотек для Common Lisp
</p>

<div class="org-src-container">

<pre class="src src-sh">mkdir -p ~/build
<span style="color: #483d8b;">cd</span> ~/build
wget https://beta.quicklisp.org/quicklisp.lisp
sbcl --load quicklisp.lisp
</pre>
</div>

<p>
Теперь мы внутри <code>quicklisp</code>-а, работающего в образе <code>sbcl</code>. Попросим
его добавить себя в инициализационный файл, чтобы <code>quicklisp</code>
загружался каждый раз, когда стартует <code>sbcl</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp">(ql:add-to-init-file)
</pre>
</div>

<p>
Выйдите из лиспа:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(quit)
</pre>
</div>

<p>
Откройте файл <code>~/.sbclrc</code> и добавьте в конец файла следующие строки,
чтобы <code>quicklisp</code> знал, где находится репозиторий с сайтом:
</p>

<div class="org-src-container">

<pre class="src src-lisp">#+quicklisp
(mapcar #'(<span style="color: #a020f0;">lambda</span> (x)
            (pushnew x ql:*local-project-directories*))
        (list #P<span style="color: #8b2252;">"~/repo/rigidus.ru/"</span>))
</pre>
</div>

<p>
Снова запустите <code>sbcl</code>
</p>

<div class="org-src-container">

<pre class="src src-sh">sbcl
</pre>
</div>

<p>
И в нем загрузите сайт:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(ql:quickload <span style="color: #8b2252;">"rigidus"</span>)
</pre>
</div>

<p>
Наберите в адресной строке броузера <code>http://localhost:9993</code> и
загрузите главную страницу.
</p>

<div class="note">
<p>
Если вы не видите главной страницы, возможно это потому, что
сгенерированные файлы не попадают в репозиторий (так может быть
настроен <code>.gitignore</code>). Если это действительно так - поместите в в
<code>/repo/rigidus.ru/www</code> файл <code>index.html</code> и проверьте, отобразился ли
он в броузере. Вы также можете пройти следующий раздел и
сгенерировать все файлы сайта, используя инструменты из него.
</p>

</div>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2">Инструменты разработки</h3>
<div class="outline-text-3" id="text-2-2">
<p>
Чтобы настроить инструменты <code>emacs</code> для поддержки литературного
программирования совершите следующие действия:
</p>

<p>
Установите <code>emacs</code>, если он еще не установлен.
</p>

<div class="org-src-container">

<pre class="src src-sh">apt-get install emacs23
</pre>
</div>

<p>
Добавьте в файл конфигурации <code>/.emacs.d/init.el</code> следующие строки, при
необходимости изменив пути к папкам:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">org-custom-link-img-follow</span> (path)
  (org-open-file-with-emacs
   (format <span style="color: #8b2252;">"../img/%s"</span> path)))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">org-custom-link-img-export</span> (path desc format)
  (<span style="color: #a020f0;">cond</span>
    ((eq format 'html)
     (format <span style="color: #8b2252;">"&lt;img src=\"/img/%s\" alt=\"%s\"/&gt;"</span> path desc))))

(org-add-link-type <span style="color: #8b2252;">"img"</span> 'org-custom-link-img-follow 'org-custom-link-img-export)

(setq org-export-time-stamp-file nil)
(setq org-publish-project-alist
      '((<span style="color: #8b2252;">"org-notes"</span>
         <span style="color: #483d8b;">:base-directory</span> <span style="color: #8b2252;">"~/repo/rigidus.ru/org/"</span>
         <span style="color: #483d8b;">:base-extension</span> <span style="color: #8b2252;">"org"</span>
         <span style="color: #483d8b;">:publishing-directory</span> <span style="color: #8b2252;">"~/repo/rigidus.ru/www/"</span>
         <span style="color: #483d8b;">:recursive</span> t
         <span style="color: #483d8b;">:publishing-function</span> org-html-publish-to-html
         <span style="color: #483d8b;">:timestamp</span> nil
         <span style="color: #483d8b;">:html-doctype</span> <span style="color: #8b2252;">"html5"</span>
         <span style="color: #483d8b;">:section-numbers</span> nil
         <span style="color: #483d8b;">:html-postamble</span> nil
         <span style="color: #483d8b;">:html-preamble</span> nil
         <span style="color: #483d8b;">:with-timestamps</span> nil
         <span style="color: #483d8b;">:timestamp</span> nil
         <span style="color: #483d8b;">:with-date</span> nil
         <span style="color: #483d8b;">:html-head-extra</span> <span style="color: #8b2252;">"&lt;link href=\"/css/style.css\" rel=\"stylesheet\" type=\"text/css\" /&gt;"</span>
         <span style="color: #483d8b;">:html-head-include-default-style</span> nil
         <span style="color: #483d8b;">:html-head-include-scripts</span> nil)
        (<span style="color: #8b2252;">"org-static"</span>
         <span style="color: #483d8b;">:base-directory</span> <span style="color: #8b2252;">"~/repo/rigidus.ru/org/"</span>
         <span style="color: #483d8b;">:base-extension</span> <span style="color: #8b2252;">"css\\|js\\|png\\|jpg\\|gif\\|pdf\\|djvu"</span>
         <span style="color: #483d8b;">:publishing-directory</span> <span style="color: #8b2252;">"~/repo/rigidus.ru/www/"</span>
         <span style="color: #483d8b;">:recursive</span> t
         <span style="color: #483d8b;">:publishing-function</span> org-publish-attachment)
        (<span style="color: #8b2252;">"org"</span>
         <span style="color: #483d8b;">:components</span> (<span style="color: #8b2252;">"org-notes"</span> <span style="color: #8b2252;">"org-static"</span>))))
</pre>
</div>

<p>
Если вы желаете заняться написанием кода на лиспе для этого проекта -
установите <code>slime</code> с <a href="https://common-lisp.net/project/slime/">официального сайта</a> или используя <code>quicklisp</code> и
сконфигурируйте его в файле конфигурации <code>emacs</code> <code>/.emacs.d/init.el</code>
поправив путь к <code>slime</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(setq inferior-lisp-program <span style="color: #8b2252;">"sbcl"</span>)
(setq slime-lisp-implementations '((sbcl (<span style="color: #8b2252;">"sbcl"</span>))))
(setq slime-startup-animation nil)
<span style="color: #b22222;">;; </span><span style="color: #b22222;">SLIME</span>
(add-to-list 'load-path <span style="color: #8b2252;">"~/quicklisp/dists/quicklisp/software/path/to/slime"</span>)
(<span style="color: #a020f0;">require</span> '<span style="color: #008b8b;">slime</span>)
</pre>
</div>

<p>
Теперь вы готовы писать лисп-код в литературном стиле.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">Как это работает</h2>
<div class="outline-text-2" id="text-3">
<p>
Мне нравится работать в <code>emacs</code> и использовать <code>orgmode</code> для
формирования структурированных документов,
</p>

<p>
Orgmode включает в себя <a href="http://orgmode.org/manual/index.html#toc_Publishing">систему публикации</a>, которая хорошо
конфигурируется. Обычно я просто выполняю из емакса команду
<code>org-publish-all</code>. Емакс осуществляет экспорт всех .org-файлов проекта
в .html, в процессе выполняя директивы в них, такие как
<code>INCLUDE</code>. Настройки экспорта задаются в конфигурации, результат
попадает в папку <code>./www/</code>
</p>

<p>
Тем не менее, мне всегда хотелось большей гибкости,
поэтому я решил взять тот результат, который она производит, построить
из него дерево s-выражений и применить все преобразования, которые мне могут
понадобиться. После этого, преобразованный результат может быть снова
транслирован в html/css/javascript и отображен на сайте.
</p>

<p>
Для того чтобы разбирать HTML-код в LHTML я использую библиотеку
<code>cl-html-parse</code>. Переносимые пути обеспечиваются механизмом трансляции
логических путей.
</p>

<p>
Вебсервер, запущенный на порту 9993, имеет несколько маршрутов,
некоторые из которых связаны с файлами из этой папки. Соответствующий
файл преобразовывется и отдается пользователю.
</p>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">Сборка</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1">Файл определения системы</h3>
<div class="outline-text-3" id="text-4-1">
<p>
Файл определения системы представляет собой каркас проекта и содержит
в себе определение системы:
</p>
<ul class="org-ul">
<li>библиотеки, от которых зависит система
</li>
<li>набор всех файлов, который должны быть загружены в лисп-процесс.
</li>
</ul>

<p>
Определение системы экпортируется из литературного исходника в
корневой каталог проекта.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="defsystem"><span style="color: #b22222;">;;;; </span><span style="color: #b22222;">&lt;&lt;copyright&gt;&gt;</span>
(asdf:defsystem #<span style="color: #483d8b;">:rigidus</span>
  <span style="color: #483d8b;">:version</span>      <span style="color: #8b2252;">"0.0.3"</span>
  <span style="color: #483d8b;">:author</span>       <span style="color: #8b2252;">"rigidus &lt;<a href="mailto:i.am.rigidus&#64;gmail.com">i.am.rigidus&#64;gmail.com</a>&gt;"</span>
  <span style="color: #483d8b;">:licence</span>      <span style="color: #8b2252;">"AGPLv3"</span>
  <span style="color: #483d8b;">:description</span>  <span style="color: #8b2252;">"site http://rigidus.ru"</span>
  <span style="color: #483d8b;">:depends-on</span>   (#<span style="color: #483d8b;">:anaphora</span>
                 #<span style="color: #483d8b;">:closer-mop</span>
                 #<span style="color: #483d8b;">:cl-ppcre</span>
                 #<span style="color: #483d8b;">:cl-base64</span>
                 #<span style="color: #483d8b;">:cl-json</span>
                 #<span style="color: #483d8b;">:cl-html5-parser</span>
                 #<span style="color: #483d8b;">:cl-who</span>
                 #<span style="color: #483d8b;">:cl-fad</span>
                 #<span style="color: #483d8b;">:optima</span>
                 #<span style="color: #483d8b;">:closure-template</span>
                 #<span style="color: #483d8b;">:drakma</span>
                 #<span style="color: #483d8b;">:restas</span>
                 #<span style="color: #483d8b;">:restas-directory-publisher</span>
                 #<span style="color: #483d8b;">:split-sequence</span>
                 #<span style="color: #483d8b;">:postmodern</span>
                 #<span style="color: #483d8b;">:restas</span>
                 #<span style="color: #483d8b;">:optima</span>
                 #<span style="color: #483d8b;">:fare-quasiquote-extras</span>
                 #<span style="color: #483d8b;">:fare-quasiquote-optima</span>)
  <span style="color: #483d8b;">:serial</span>       t
  <span style="color: #483d8b;">:components</span>   ((<span style="color: #483d8b;">:module</span> <span style="color: #8b2252;">"src"</span>
                          <span style="color: #483d8b;">:serial</span> t
                          <span style="color: #483d8b;">:pathname</span> <span style="color: #8b2252;">"src"</span>
                          <span style="color: #483d8b;">:components</span> ((<span style="color: #483d8b;">:static-file</span> <span style="color: #8b2252;">"templates.htm"</span>)
                                       (<span style="color: #483d8b;">:file</span> <span style="color: #8b2252;">"prepare"</span>)
                                       (<span style="color: #483d8b;">:file</span> <span style="color: #8b2252;">"defmodule"</span>)
                                       (<span style="color: #483d8b;">:file</span> <span style="color: #8b2252;">"html"</span>)
                                       (<span style="color: #483d8b;">:file</span> <span style="color: #8b2252;">"ext-html"</span>)
                                       (<span style="color: #483d8b;">:file</span> <span style="color: #8b2252;">"orgmode"</span>)
                                       (<span style="color: #483d8b;">:file</span> <span style="color: #8b2252;">"render"</span>)
                                       (<span style="color: #483d8b;">:file</span> <span style="color: #8b2252;">"routes"</span>)
                                       (<span style="color: #483d8b;">:file</span> <span style="color: #8b2252;">"init"</span>)
                                       (<span style="color: #483d8b;">:static-file</span> <span style="color: #8b2252;">"daemon.conf"</span>)
                                       (<span style="color: #483d8b;">:static-file</span> <span style="color: #8b2252;">"daemon.lisp"</span>)
                                       (<span style="color: #483d8b;">:static-file</span> <span style="color: #8b2252;">"daemon.sh"</span>)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2">Подготовка к запуску</h3>
<div class="outline-text-3" id="text-4-2">
<p>
Этот файл компилирует шаблоны и создает пакет <code>TPL</code>. Он делает это еще до объявления
базового пакета. Для того чтобы в процессе загрузки все ссылки на этот пакет были
правильно разрешены, необходимо, чтобы создание пакета завершилось к моменту появления
ссылок на него. А для этого нужно помещать компиляцию в отдельный файл.
</p>

<p>
Однако тогда у нас возникает проблема, заключающаяся в том, что <code>base-dir</code>, путь, от
которого отсчитываются все пути придется объявлять дважды - вне пакета и внутри
него. Мы решаем эту проблему средствами подстановки литературного программирования:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="base_dir">(merge-pathnames
 (make-pathname <span style="color: #483d8b;">:directory</span> '(<span style="color: #483d8b;">:relative</span> <span style="color: #8b2252;">"repo/rigidus.ru"</span>))
 (user-homedir-pathname))
</pre>
</div>


<div class="org-src-container">

<pre class="src src-lisp" id="prepare"><span style="color: #b22222;">;;;; </span><span style="color: #b22222;">&lt;&lt;copyright&gt;&gt;</span>

(closure-template:compile-template
 <span style="color: #483d8b;">:common-lisp-backend</span> (merge-pathnames
                       (make-pathname <span style="color: #483d8b;">:name</span> <span style="color: #8b2252;">"templates"</span> <span style="color: #483d8b;">:type</span> <span style="color: #8b2252;">"htm"</span>)
                       (merge-pathnames
                        (make-pathname <span style="color: #483d8b;">:directory</span> '(<span style="color: #483d8b;">:relative</span> <span style="color: #8b2252;">"src"</span>))
                        &lt;&lt;base_dir&gt;&gt;)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3">Определение пакетов</h3>
<div class="outline-text-3" id="text-4-3">
<p>
Что такое пакет и зачем он нужен лучше всего прочитать <a href="doc/packages-in-lisp.html">тут</a>. Обычно
определение пакетов экспортируется в файл <code>src/package.lisp</code>, но этот
проект слишком простой, он содержит всего один пакет. Поэтому
определение пакета происходит в разделе <a href="#sec-4-6">Определение модуля</a>
</p>
</div>
</div>

<div id="outline-container-sec-4-4" class="outline-3">
<h3 id="sec-4-4">Утилиты</h3>
<div class="outline-text-3" id="text-4-4">
<p>
Несколько маленьких утилитарных функций определены здесь. При экспорте
они подключатся в тот же файл, где происходит определение модуля. Это
функции:
</p>
<ul class="org-ul">
<li>отладочного вывода и ошибок
</li>
<li>получения содержимого директории
</li>
<li>трансформации дерева, в которое разбирается html из файла
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="utility">(<span style="color: #a020f0;">in-package</span> <span style="color: #483d8b;">:rigidus</span>)

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">bprint</span> (var)
  `(subseq (<span style="color: #a020f0;">with-output-to-string</span> (*standard-output*)
             (pprint ,var)) 1))

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">err</span> (var)
  `(<span style="color: #ff0000; font-weight: bold;">error</span> (format nil <span style="color: #8b2252;">"ERR:[~A]"</span> (bprint ,var))))

(<span style="color: #a020f0;">define-condition</span> <span style="color: #0000ff;">pattern-not-found-error</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((text <span style="color: #483d8b;">:initarg</span> <span style="color: #483d8b;">:text</span> <span style="color: #483d8b;">:reader</span> text)))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">extract</span> (cortege html)
  (<span style="color: #a020f0;">loop</span> <span style="color: #483d8b;">:for</span> (begin end regexp) <span style="color: #483d8b;">:in</span> cortege <span style="color: #483d8b;">:collect</span>
     (<span style="color: #a020f0;">multiple-value-bind</span> (start fin)
         (ppcre:scan regexp html)
       (<span style="color: #a020f0;">when</span> (null start)
         (<span style="color: #ff0000; font-weight: bold;">error</span> 'pattern-not-found-error <span style="color: #483d8b;">:text</span> regexp))
       (subseq html (+ start begin) (- fin end)))))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">get-directory-contents</span> (path)
  <span style="color: #8b2252;">"&#1060;&#1091;&#1085;&#1082;&#1094;&#1080;&#1103; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1090; &#1089;&#1086;&#1076;&#1077;&#1088;&#1078;&#1080;&#1084;&#1086;&#1077; &#1082;&#1072;&#1090;&#1072;&#1083;&#1086;&#1075;&#1072;"</span>
  (<span style="color: #a020f0;">when</span> (not (equal <span style="color: #8b2252;">"/"</span> (coerce (last (coerce path 'list)) 'string)))
    (setf path (format nil <span style="color: #8b2252;">"~A/"</span> path)))
  (directory (format nil <span style="color: #8b2252;">"~A*.*"</span> path)))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">maptree-transform</span> (predicate-transformer tree)
  (<span style="color: #a020f0;">multiple-value-bind</span> (t-tree control)
      (aif (funcall predicate-transformer tree)
           it
           (values tree #'mapcar))
    (<span style="color: #a020f0;">if</span> (and (consp t-tree)
             control)
        (funcall control
                 #'(<span style="color: #a020f0;">lambda</span> (x)
                     (maptree-transform predicate-transformer x))
                 t-tree)
        t-tree)))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">mtm - &#1089;&#1080;&#1085;&#1090;&#1072;&#1082;&#1089;&#1080;&#1095;&#1077;&#1089;&#1082;&#1080;&#1081; &#1089;&#1072;&#1093;&#1072;&#1088; &#1076;&#1083;&#1103; maptree-transform</span>
(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">mtm</span> (transformer tree)
  (<span style="color: #a020f0;">let</span> ((lambda-param (gensym)))
    `(maptree-transform #'(<span style="color: #a020f0;">lambda</span> (,lambda-param)
                            (values (optima:match ,lambda-param ,transformer)
                                    #'mapcar))
                        ,tree)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-5" class="outline-3">
<h3 id="sec-4-5">Copyright</h3>
<div class="outline-text-3" id="text-4-5">
<p>
Копирайт вставляется в каждый сгенерированный файл для того чтобы
соблюсти требования лицензии AGPL
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="copyright">Copyright &#169; 2014-2017 Glukhov Mikhail. All rights reserved.
Licensed under the GNU AGPLv3
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-6" class="outline-3">
<h3 id="sec-4-6">Определение модуля</h3>
<div class="outline-text-3" id="text-4-6">
<p>
Файл определения модуля экспортируется в каталог src. Во время
экспорта в него включаются утилиты.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="defmodule"><span style="color: #b22222;">;;;; </span><span style="color: #b22222;">&lt;&lt;copyright&gt;&gt;</span>
(<span style="color: #a020f0;">restas:define-module</span> #<span style="color: #483d8b;">:rigidus</span>
  (<span style="color: #483d8b;">:use</span> #<span style="color: #483d8b;">:closer-mop</span> #<span style="color: #483d8b;">:cl</span> #<span style="color: #483d8b;">:iter</span> #<span style="color: #483d8b;">:alexandria</span> #<span style="color: #483d8b;">:anaphora</span> #<span style="color: #483d8b;">:postmodern</span>)
  (<span style="color: #483d8b;">:shadowing-import-from</span> <span style="color: #483d8b;">:closer-mop</span>
                          <span style="color: #483d8b;">:defclass</span>
                          <span style="color: #483d8b;">:defmethod</span>
                          <span style="color: #483d8b;">:standard-class</span>
                          <span style="color: #483d8b;">:ensure-generic-function</span>
                          <span style="color: #483d8b;">:defgeneric</span>
                          <span style="color: #483d8b;">:standard-generic-function</span>
                          <span style="color: #483d8b;">:class-name</span>))

(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:rigidus</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">special syntax for pattern-matching - ON</span>
(named-readtables:in-readtable <span style="color: #483d8b;">:fare-quasiquote</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1047;&#1076;&#1077;&#1089;&#1100; &#1087;&#1086;&#1076;&#1082;&#1083;&#1102;&#1095;&#1072;&#1102;&#1090;&#1089;&#1103; &#1091;&#1090;&#1080;&#1083;&#1080;&#1090;&#1099;</span>
&lt;&lt;utility&gt;&gt;

<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1052;&#1077;&#1093;&#1072;&#1085;&#1080;&#1079;&#1084; &#1090;&#1088;&#1072;&#1085;&#1089;&#1083;&#1103;&#1094;&#1080;&#1080; &#1087;&#1091;&#1090;&#1077;&#1081;</span>
&lt;&lt;pathname-translations&gt;&gt;

<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1056;&#1072;&#1073;&#1086;&#1090;&#1072; &#1089; html tree</span>
&lt;&lt;html_s_tree&gt;&gt;

<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1052;&#1077;&#1093;&#1072;&#1085;&#1080;&#1079;&#1084; &#1087;&#1088;&#1077;&#1086;&#1073;&#1088;&#1072;&#1079;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103; &#1089;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;</span>
&lt;&lt;enobler&gt;&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-7" class="outline-3">
<h3 id="sec-4-7">Инициализация</h3>
<div class="outline-text-3" id="text-4-7">
<p>
Эта часть запускает сервер на 9993 порту.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="init"><span style="color: #b22222;">;;;; </span><span style="color: #b22222;">&lt;&lt;copyright&gt;&gt;</span>
(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:rigidus</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">start</span>
(restas:start '#<span style="color: #483d8b;">:rigidus</span> <span style="color: #483d8b;">:port</span> 9993)
(restas:debug-mode-on)
<span style="color: #b22222;">;; </span><span style="color: #b22222;">(restas:debug-mode-off)</span>
(setf hunchentoot:*catch-errors-p* t)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">Трансляция путей</h2>
<div class="outline-text-2" id="text-5">
<p>
Трансляция путей производится с помощью встроенного механизма
<code>logical-pathname-translations</code>
</p>

<p>
По-умолчанию считается, что директория, от которой отсчитываются
пути: <code>~/repo/rigidus.ru</code>. Я не стал создавать отдельный
конфигурационный файл для этой информации.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="pathname-translations">(<span style="color: #a020f0;">in-package</span> <span style="color: #483d8b;">:rigidus</span>)

(<span style="color: #a020f0;">defparameter</span> <span style="color: #a0522d;">*base-dir*</span>
  &lt;&lt;base_dir&gt;&gt;)

(<span style="color: #a020f0;">defparameter</span> <span style="color: #a0522d;">*base-path*</span> (directory-namestring *base-dir*))

(setf (logical-pathname-translations <span style="color: #8b2252;">"org"</span>)
      `((<span style="color: #8b2252;">"source;*.*"</span>
         ,(concatenate 'string *base-path* <span style="color: #8b2252;">"org/*.org"</span>))
        (<span style="color: #8b2252;">"publish;*.*"</span>
         ,(concatenate 'string *base-path* <span style="color: #8b2252;">"www/*.html"</span>))))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(translate-logical-pathname "org:source;articles;about.txt")</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">;; #P"/home/rigidus/repo/rigidus.ru/org/articles/about.org"</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">(translate-logical-pathname "org:source;articles;emacs;about.txt")</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">;; #P"/home/rigidus/repo/rigidus.ru/org/articles/emacs/about.org"</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">(translate-logical-pathname "org:publish;articles;about.txt")</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">;; #P"/home/rigidus/repo/rigidus.ru/www/articles/about.org"</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">(translate-logical-pathname "org:publish;articles;emacs;about.txt")</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">;; #P"/home/rigidus/repo/rigidus.ru/www/articles/emacs/about.org"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6">Шаблон блоков статистики</h2>
<div class="outline-text-2" id="text-6">
<p>
Это статистика от яндекса, гугла и liveinternet counter
</p>

<p>
[TODO:gmm] - обновить
</p>

<div class="org-src-container">

<pre class="src src-html" id="tpl_stat">// -*- mode: closure-template-html; fill-column: 140 -*-

{namespace tpl}

{template stat}

{literal}
 &lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">style</span>=<span style="color: #8b2252;">"position:absolute; left:-9999px;"</span>&gt;

    <span style="color: #b22222;">&lt;!--</span><span style="color: #b22222;">Google Analitics </span><span style="color: #b22222;">--&gt;</span>
    &lt;<span style="color: #0000ff;">script</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text/javascript"</span>&gt;
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-20801780-1']);
        _gaq.push(['_trackPageview']);
        (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    &lt;/<span style="color: #0000ff;">script</span>&gt;
    <span style="color: #b22222;">&lt;!--</span><span style="color: #b22222;">Google Analitics </span><span style="color: #b22222;">--&gt;</span>

    <span style="color: #b22222;">&lt;!--</span><span style="color: #b22222;">LiveInternet counter</span><span style="color: #b22222;">--&gt;</span>
    &lt;<span style="color: #0000ff;">script</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text/javascript"</span>&gt;
        <span style="color: #b22222;">&lt;!--</span>
<span style="color: #b22222;">             document.write("&lt;a href='http://www.liveinternet.ru/click' "+</span>
<span style="color: #b22222;">             "target=_blank&gt;&lt;img src='//counter.yadro.ru/hit?t24.5;r"+</span>
<span style="color: #b22222;">             escape(document.referrer)+((typeof(screen)=="undefined")?"":</span>
<span style="color: #b22222;">             ";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?</span>
<span style="color: #b22222;">             screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+</span>
<span style="color: #b22222;">             ";h"+escape(document.title.substring(0,80))+";"+Math.random()+</span>
<span style="color: #b22222;">             "' alt='' title='LiveInternet: &#1087;&#1086;&#1082;&#1072;&#1079;&#1072;&#1085;&#1086; &#1095;&#1080;&#1089;&#1083;&#1086; &#1087;&#1086;&#1089;&#1077;&#1090;&#1080;&#1090;&#1077;&#1083;&#1077;&#1081; &#1079;&#1072;"+</span>
<span style="color: #b22222;">             " &#1089;&#1077;&#1075;&#1086;&#1076;&#1085;&#1103;' "+</span>
<span style="color: #b22222;">             "border='0' width='88' height='15'&gt;&lt;\/a&gt;")</span>
<span style="color: #b22222;">    //</span><span style="color: #b22222;">--&gt;</span>
    &lt;/<span style="color: #0000ff;">script</span>&gt;
    <span style="color: #b22222;">&lt;!--</span><span style="color: #b22222;">/LiveInternet</span><span style="color: #b22222;">--&gt;</span>


    <span style="color: #b22222;">&lt;!-- </span><span style="color: #b22222;">Yandex.Metrika informer </span><span style="color: #b22222;">--&gt;</span>
    &lt;<span style="color: #0000ff;">a</span> <span style="color: #a0522d;">href</span>=<span style="color: #8b2252;">"https://metrika.yandex.ru/stat/?id=3701317&amp;amp;from=informer"</span>
    <span style="color: #a0522d;">target</span>=<span style="color: #8b2252;">"_blank"</span> <span style="color: #a0522d;">rel</span>=<span style="color: #8b2252;">"nofollow"</span>&gt;&lt;<span style="color: #0000ff;">img</span> <span style="color: #a0522d;">src</span>=<span style="color: #8b2252;">"//bs.yandex.ru/informer/3701317/1_0_9F9F9FFF_7F7F7FFF_0_pageviews"</span>
    <span style="color: #a0522d;">style</span>=<span style="color: #8b2252;">"width:80px; height:15px; border:0;"</span> <span style="color: #a0522d;">alt</span>=<span style="color: #8b2252;">"&#1071;&#1085;&#1076;&#1077;&#1082;&#1089;.&#1052;&#1077;&#1090;&#1088;&#1080;&#1082;&#1072;"</span> <span style="color: #a0522d;">title</span>=<span style="color: #8b2252;">"&#1071;&#1085;&#1076;&#1077;&#1082;&#1089;.&#1052;&#1077;&#1090;&#1088;&#1080;&#1082;&#1072;: &#1076;&#1072;&#1085;&#1085;&#1099;&#1077; &#1079;&#1072; &#1089;&#1077;&#1075;&#1086;&#1076;&#1085;&#1103; (&#1087;&#1088;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1099;)"</span>
                                        <span style="color: #a0522d;">onclick</span>=<span style="color: #8b2252;">"try{Ya.Metrika.informer({i:this,id:3701317,lang:'ru'});return false}catch(e){}"</span>/&gt;&lt;/<span style="color: #0000ff;">a</span>&gt;
    <span style="color: #b22222;">&lt;!-- </span><span style="color: #b22222;">/Yandex.Metrika informer </span><span style="color: #b22222;">--&gt;</span>

    <span style="color: #b22222;">&lt;!-- </span><span style="color: #b22222;">Yandex.Metrika counter </span><span style="color: #b22222;">--&gt;</span>
    &lt;<span style="color: #0000ff;">script</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text/javascript"</span>&gt;
    (function (d, w, c) {
        (w[c] = w[c] || []).push(function() {
            try {
                w.yaCounter3701317 = new Ya.Metrika({id:3701317,
                        webvisor:true,
                        clickmap:true,
                        trackLinks:true,
                        accurateTrackBounce:true});
            } catch(e) { }
        });

        var n = d.getElementsByTagName(<span style="color: #8b2252;">"script"</span>)[0],
            s = d.createElement(<span style="color: #8b2252;">"script"</span>),
            f = function () { n.parentNode.insertBefore(s, n); };
        s.type = <span style="color: #8b2252;">"text/javascript"</span>;
        s.async = true;
        s.src = (d.location.protocol == <span style="color: #8b2252;">"https:"</span> ? <span style="color: #8b2252;">"https:"</span> : <span style="color: #8b2252;">"http:"</span>) + <span style="color: #8b2252;">"//mc.yandex.ru/metrika/watch.js"</span>;

        if (w.opera == <span style="color: #8b2252;">"[object Opera]"</span>) {
            d.addEventListener(<span style="color: #8b2252;">"DOMContentLoaded"</span>, f, false);
        } else { f(); }
    })(document, window, <span style="color: #8b2252;">"yandex_metrika_callbacks"</span>);
    &lt;/<span style="color: #0000ff;">script</span>&gt;

    &lt;<span style="color: #0000ff;">noscript</span>&gt;&lt;<span style="color: #0000ff;">div</span>&gt;&lt;<span style="color: #0000ff;">img</span> <span style="color: #a0522d;">src</span>=<span style="color: #8b2252;">"//mc.yandex.ru/watch/3701317"</span> <span style="color: #a0522d;">style</span>=<span style="color: #8b2252;">"position:absolute; left:-9999px;"</span> <span style="color: #a0522d;">alt</span>=<span style="color: #8b2252;">""</span> /&gt;&lt;/<span style="color: #0000ff;">div</span>&gt;&lt;/<span style="color: #0000ff;">noscript</span>&gt;
    <span style="color: #b22222;">&lt;!-- </span><span style="color: #b22222;">/Yandex.Metrika counter </span><span style="color: #b22222;">--&gt;</span>

  &lt;/<span style="color: #0000ff;">div</span>&gt;
{/literal}

{/template}
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7">Html-tree</h2>
<div class="outline-text-2" id="text-7">
<p>
В процессе работы бывает очень полезным представление страницы в виде дерева
s-выражений. Для того чтобы разбирать html в дерево и собирать его обратно используется
парсер из библиотеки <code>html5-parser</code> и простой сборщик, сохраняющий отступы:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="html_s_tree">(<span style="color: #a020f0;">in-package</span> <span style="color: #483d8b;">:rigidus</span>)

&lt;&lt;html_to_tree&gt;&gt;
&lt;&lt;tree_to_html&gt;&gt;
</pre>
</div>
</div>

<div id="outline-container-sec-7-1" class="outline-3">
<h3 id="sec-7-1">Парсинг html</h3>
<div class="outline-text-3" id="text-7-1">
<p>
Разбираем html в дерево s-выражений
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="html_to_tree">(<span style="color: #a020f0;">in-package</span> <span style="color: #483d8b;">:rigidus</span>)

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">html-to-tree</span> (html)
  <span style="color: #b22222;">;; </span><span style="color: #b22222;">(html5-parser:node-to-xmls</span>
  (html5-parser:parse-html5-fragment html <span style="color: #483d8b;">:dom</span> <span style="color: #483d8b;">:xmls</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-7-2" class="outline-3">
<h3 id="sec-7-2">Сборка в html</h3>
<div class="outline-text-3" id="text-7-2">
<div class="org-src-container">

<pre class="src src-lisp" id="tree_to_html">(<span style="color: #a020f0;">in-package</span> <span style="color: #483d8b;">:rigidus</span>)

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">tree-to-html</span> (tree <span style="color: #228b22;">&amp;optional</span> (step 0))
  (<span style="color: #a020f0;">macrolet</span> ((indent ()
               `(make-string (* 3 step) <span style="color: #483d8b;">:initial-element</span> #\Space)))
    (<span style="color: #a020f0;">labels</span> ((paired (subtree)
               (format nil <span style="color: #8b2252;">"~A&lt;~A~A&gt;~%~A~4:*~A&lt;/~A&gt;~%"</span>
                       (indent)
                       (car subtree)
                       (format nil <span style="color: #8b2252;">"~:[~; ~1:*~{~A~^ ~}~]"</span>
                               (mapcar #'(<span style="color: #a020f0;">lambda</span> (attr)
                                           (<span style="color: #a020f0;">let</span> ((key (car attr))
                                                 (val (cadr attr)))
                                             (format nil <span style="color: #8b2252;">"~A=\"~A\""</span> key val)))
                                       (cadr subtree)))
                       (format nil <span style="color: #8b2252;">"~{~A~}"</span>
                               (<span style="color: #a020f0;">progn</span>
                                 (incf step)
                                 (<span style="color: #a020f0;">let</span> ((ret (mapcar #'(<span style="color: #a020f0;">lambda</span> (x)
                                                        (subtree-to-html x step))
                                                    (cddr subtree))))
                                   (decf step)
                                   ret)))))
             (singled (subtree)
               (format nil <span style="color: #8b2252;">"~A&lt;~A~A /&gt;~%"</span>
                       (indent)
                       (car subtree)
                       (format nil <span style="color: #8b2252;">"~:[~; ~1:*~{~A~^ ~}~]"</span>
                               (mapcar #'(<span style="color: #a020f0;">lambda</span> (attr)
                                           (<span style="color: #a020f0;">let</span> ((key (car attr))
                                                 (val (cadr attr)))
                                             (format nil <span style="color: #8b2252;">"~A=\"~A\""</span> key val)))
                                       (cadr subtree)))))
             (subtree-to-html (subtree <span style="color: #228b22;">&amp;optional</span> (step 0))
               (<span style="color: #a020f0;">cond</span> ((stringp subtree) (format nil <span style="color: #8b2252;">"~A~A~%"</span> (indent) subtree))
                     ((numberp subtree) (format nil <span style="color: #8b2252;">"~A~A~%"</span> (indent) subtree))
                     ((listp   subtree)
                      (<span style="color: #a020f0;">let</span> ((tag (car subtree)))
                        (<span style="color: #a020f0;">cond</span> ((or (equal tag <span style="color: #8b2252;">"img"</span>)
                                   (equal tag <span style="color: #8b2252;">"link"</span>)
                                   (equal tag <span style="color: #8b2252;">"meta"</span>))  (singled subtree))
                              (t (paired subtree)))))
                     (t (format nil <span style="color: #8b2252;">"[:err:~A]"</span> subtree)))))
      (reduce #'(<span style="color: #a020f0;">lambda</span> (a b) (concatenate 'string a b))
              (mapcar #'(<span style="color: #a020f0;">lambda</span> (x) (subtree-to-html x step))
                      tree)))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8">Преобразование страниц</h2>
<div class="outline-text-2" id="text-8">
<p>
Здесь механизм, который разбирает файлы, строит из них дерево s-выражений и
осуществляет его трансформацию.
</p>

<p>
Я обнаружил определенную проблему с ним, связанную с выводом листингов внутри тега
<code>&lt;pre&gt;&lt;/pre&gt;</code> - из-за отступов, которые формирует <code>tree-to-html</code> сьезжает
форматирование исходного кода. Поэтому, до написания своего парсера, учитывающего эти
аспекты, я закомментировал такую обработку, тем более, что в данный момент
трансформация заключается просто в присоединении шаблона, содержащего трекеры
статистики.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="enobler">(<span style="color: #a020f0;">in-package</span> <span style="color: #483d8b;">:rigidus</span>)

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">enobler</span> (pathname <span style="color: #228b22;">&amp;optional</span> dbg)
  (<span style="color: #a020f0;">let*</span> ((file-contents (alexandria:read-file-into-string pathname))
         (onestring (cl-ppcre:regex-replace-all <span style="color: #8b2252;">"(\\n|\\s*$)"</span> file-contents (<span style="color: #a020f0;">if</span> dbg <span style="color: #8b2252;">""</span> <span style="color: #8b2252;">" "</span>)))
         (tree (html-to-tree onestring))
         <span style="color: #b22222;">;; </span><span style="color: #b22222;">(inject-css '("link" (("href" "/css/style.css") ("rel" "stylesheet") ("type" "text/css"))))</span>
         <span style="color: #b22222;">;; </span><span style="color: #b22222;">(replace-css #'(lambda (in)</span>
         <span style="color: #b22222;">;;                  </span><span style="color: #b22222;">(optima:match in</span>
         <span style="color: #b22222;">;;                    </span><span style="color: #b22222;">(`("style" (("type" "text/css")) ,_) inject-css))))</span>
         <span style="color: #b22222;">;; </span><span style="color: #b22222;">(remove-css (maptree-transform replace-css tree))</span>
         <span style="color: #b22222;">;; </span><span style="color: #b22222;">(inject-js '("script" (("src" "scripts.js"))))</span>
         <span style="color: #b22222;">;; </span><span style="color: #b22222;">(replace-js  #'(lambda (in)</span>
         <span style="color: #b22222;">;;                  </span><span style="color: #b22222;">(optima:match in</span>
         <span style="color: #b22222;">;;                    </span><span style="color: #b22222;">(`("script" (("type" "text/javascript")) ,_) inject-js))))</span>
         <span style="color: #b22222;">;; </span><span style="color: #b22222;">(remove-js (maptree-transform replace-js remove-css))</span>
         (result tree))
    (<span style="color: #a020f0;">if</span> dbg
        result
        (format nil <span style="color: #8b2252;">"~A~A~%~A~%~A"</span>
                <span style="color: #b22222;">;; </span><span style="color: #b22222;">"&lt;!DOCTYPE html&gt;\n"</span>
                <span style="color: #8b2252;">""</span>
                <span style="color: #b22222;">;; </span><span style="color: #b22222;">(tree-to-html result)</span>
                file-contents
                (tpl:stat)
                <span style="color: #8b2252;">"  &lt;div id=\"linker\"&gt;&lt;a href=\"/\"&gt;Home&lt;/a&gt;&lt;/div&gt;"</span>
                ))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9">Рендеринг</h2>
<div class="outline-text-2" id="text-9">
<p>
RESTAS использует концепцию <code>рендера</code> чтобы отделить отображение страницы от ее
маршрута. Нам надо определить рендер для вывода orgmode-страниц:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="render"><span style="color: #b22222;">;;;; </span><span style="color: #b22222;">&lt;&lt;copyright&gt;&gt;</span>
(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:rigidus</span>)

(<span style="color: #a020f0;">defclass</span> <span style="color: #228b22;">orgmode-handler</span> () ())

(<span style="color: #a020f0;">defmethod</span> <span style="color: #0000ff;">restas:render-object</span> ((renderer orgmode-handler) (file pathname))
  <span style="color: #b22222;">;; </span><span style="color: #b22222;">NOTE: &#1054;&#1089;&#1090;&#1072;&#1074;&#1083;&#1077;&#1085;&#1086; &#1082;&#1072;&#1082; &#1087;&#1088;&#1080;&#1084;&#1077;&#1088; &#1074;&#1099;&#1079;&#1086;&#1074;&#1072; CGI</span>
  <span style="color: #b22222;">;; </span><span style="color: #b22222;">(cond</span>
  <span style="color: #b22222;">;;   </span><span style="color: #b22222;">((and (string= (pathname-type file) "cgi"))</span>
  <span style="color: #b22222;">;;    </span><span style="color: #b22222;">(hunchentoot-cgi::handle-cgi-script file))</span>
  <span style="color: #b22222;">;;   </span><span style="color: #b22222;">(t</span>
  <span style="color: #b22222;">;;    </span><span style="color: #b22222;">(call-next-method)))</span>
  (enobler file))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-10" class="outline-2">
<h2 id="sec-10">Маршрутизация</h2>
<div class="outline-text-2" id="text-10">
<p>
Маршрутизация осуществляется средствами библиотеки <code>RESTAS</code>, документация по
которой доступна <a href="http://github.com/archimag/restas/">здесь</a>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="routes"><span style="color: #b22222;">;;;; </span><span style="color: #b22222;">&lt;&lt;copyright&gt;&gt;</span>
(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:rigidus</span>)

&lt;&lt;route_static_files&gt;&gt;
&lt;&lt;route_404&gt;&gt;
&lt;&lt;route_robots&gt;&gt;
&lt;&lt;route_orgmode&gt;&gt;
&lt;&lt;route_pages&gt;&gt;
</pre>
</div>
</div>

<div id="outline-container-sec-10-1" class="outline-3">
<h3 id="sec-10-1">Статические файлы</h3>
<div class="outline-text-3" id="text-10-1">
<p>
Для всех файлов, которые должны отдаваться "как есть", таких как картинки, скрипты и
стили предусмотрены соответствующие маршруты:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="route_static_files">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:rigidus</span>)

(restas:mount-module -css- (#<span style="color: #483d8b;">:restas.directory-publisher</span>)
  (<span style="color: #483d8b;">:url</span> <span style="color: #8b2252;">"/css/"</span>)
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname <span style="color: #483d8b;">:directory</span> '(<span style="color: #483d8b;">:relative</span> <span style="color: #8b2252;">"css"</span>))
                    *base-dir*)))

(restas:mount-module -img- (#<span style="color: #483d8b;">:restas.directory-publisher</span>)
  (<span style="color: #483d8b;">:url</span> <span style="color: #8b2252;">"/img/"</span>)
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname <span style="color: #483d8b;">:directory</span> '(<span style="color: #483d8b;">:relative</span> <span style="color: #8b2252;">"img"</span>))
                    *base-dir*)))

(restas:mount-module -js- (#<span style="color: #483d8b;">:restas.directory-publisher</span>)
  (<span style="color: #483d8b;">:url</span> <span style="color: #8b2252;">"/js/"</span>)
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname <span style="color: #483d8b;">:directory</span> '(<span style="color: #483d8b;">:relative</span> <span style="color: #8b2252;">"js"</span>))
                    *base-dir*)))

(restas:mount-module -resources- (#<span style="color: #483d8b;">:restas.directory-publisher</span>)
  (<span style="color: #483d8b;">:url</span> <span style="color: #8b2252;">"/resources"</span>)
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname <span style="color: #483d8b;">:directory</span> '(<span style="color: #483d8b;">:relative</span> <span style="color: #8b2252;">"resources"</span>))
                    *base-dir*)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-10-2" class="outline-3">
<h3 id="sec-10-2">404 страница</h3>
<div class="outline-text-3" id="text-10-2">
<p>
Для ненайденных страниц мы определяем страницу с 404 ошибкой.
</p>

<p>
[TODO:gmm] - Сделать ее более функциональной и красивой
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="route_404">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:rigidus</span>)

(<span style="color: #a020f0;">defparameter</span> <span style="color: #a0522d;">*log-404*</span> nil)

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">page-404</span> (<span style="color: #228b22;">&amp;optional</span> (title <span style="color: #8b2252;">"404 Not Found"</span>) (content <span style="color: #8b2252;">"&#1057;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;&#1072; &#1085;&#1077; &#1085;&#1072;&#1081;&#1076;&#1077;&#1085;&#1072;"</span>))
  <span style="color: #8b2252;">"404 Not Found"</span>)

(<span style="color: #a020f0;">restas:define-route</span> not-found-route (<span style="color: #8b2252;">"*any"</span>)
  (push any *log-404*)
  (restas:abort-route-handler
   (page-404)
   <span style="color: #483d8b;">:return-code</span> hunchentoot:+http-not-found+
   <span style="color: #483d8b;">:content-type</span> <span style="color: #8b2252;">"text/html"</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-10-3" class="outline-3">
<h3 id="sec-10-3">Страница robots.txt</h3>
<div class="outline-text-3" id="text-10-3">
<p>
Для указаний поисковым краулерам делаем страницу <code>robots.txt</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="route_robots">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:rigidus</span>)

(<span style="color: #a020f0;">restas:define-route</span> robots (<span style="color: #8b2252;">"/robots.txt"</span>)
  (format nil <span style="color: #8b2252;">"User-agent: *~%Disallow: "</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-10-4" class="outline-3">
<h3 id="sec-10-4">Страницы orgmode</h3>
<div class="outline-text-3" id="text-10-4">
<p>
Для отображения страниц, экспортированных из orgmode, используется <code>render-method</code>,
который преобразует код страницы перед выдачей пользователю:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="route_orgmode">(<span style="color: #a020f0;">in-package</span> <span style="color: #483d8b;">:rigidus</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(restas:mount-module -base- (#:restas.directory-publisher)</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(:url "/")</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(:render-method (make-instance 'orgmode-handler))</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(restas.directory-publisher:*directory*</span>
<span style="color: #b22222;">;;    </span><span style="color: #b22222;">(merge-pathnames (make-pathname :directory '(:relative "www"))</span>
<span style="color: #b22222;">;;                     </span><span style="color: #b22222;">*base-dir*)))</span>

(restas:mount-module -doc- (#<span style="color: #483d8b;">:restas.directory-publisher</span>)
  (<span style="color: #483d8b;">:url</span> <span style="color: #8b2252;">"/doc"</span>)
  (<span style="color: #483d8b;">:render-method</span> (make-instance 'orgmode-handler))
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname <span style="color: #483d8b;">:directory</span> '(<span style="color: #483d8b;">:relative</span> <span style="color: #8b2252;">"www/doc"</span>))
                    *base-dir*)))

(restas:mount-module -about- (#<span style="color: #483d8b;">:restas.directory-publisher</span>)
  (<span style="color: #483d8b;">:url</span> <span style="color: #8b2252;">"/about"</span>)
  (<span style="color: #483d8b;">:render-method</span> (make-instance 'orgmode-handler))
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname <span style="color: #483d8b;">:directory</span> '(<span style="color: #483d8b;">:relative</span> <span style="color: #8b2252;">"www/about"</span>))
                    *base-dir*)))

(restas:mount-module -prj- (#<span style="color: #483d8b;">:restas.directory-publisher</span>)
  (<span style="color: #483d8b;">:url</span> <span style="color: #8b2252;">"/prj"</span>)
  (<span style="color: #483d8b;">:render-method</span> (make-instance 'orgmode-handler))
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname <span style="color: #483d8b;">:directory</span> '(<span style="color: #483d8b;">:relative</span> <span style="color: #8b2252;">"www/prj"</span>))
                    *base-dir*)))

(restas:mount-module -holy- (#<span style="color: #483d8b;">:restas.directory-publisher</span>)
  (<span style="color: #483d8b;">:url</span> <span style="color: #8b2252;">"/holy"</span>)
  (<span style="color: #483d8b;">:render-method</span> (make-instance 'orgmode-handler))
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname <span style="color: #483d8b;">:directory</span> '(<span style="color: #483d8b;">:relative</span> <span style="color: #8b2252;">"www/holy"</span>))
                    *base-dir*)))

(restas:mount-module -lrn/asm- (#<span style="color: #483d8b;">:restas.directory-publisher</span>)
  (<span style="color: #483d8b;">:url</span> <span style="color: #8b2252;">"/lrn/asm"</span>)
  (<span style="color: #483d8b;">:render-method</span> (make-instance 'orgmode-handler))
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname <span style="color: #483d8b;">:directory</span> '(<span style="color: #483d8b;">:relative</span> <span style="color: #8b2252;">"www/lrn/asm"</span>))
                    *base-dir*)))

(restas:mount-module -lrn/forth- (#<span style="color: #483d8b;">:restas.directory-publisher</span>)
  (<span style="color: #483d8b;">:url</span> <span style="color: #8b2252;">"/lrn/forth"</span>)
  (<span style="color: #483d8b;">:render-method</span> (make-instance 'orgmode-handler))
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname <span style="color: #483d8b;">:directory</span> '(<span style="color: #483d8b;">:relative</span> <span style="color: #8b2252;">"www/lrn/forth"</span>))
                    *base-dir*)))

(restas:mount-module -lrn/lisp- (#<span style="color: #483d8b;">:restas.directory-publisher</span>)
  (<span style="color: #483d8b;">:url</span> <span style="color: #8b2252;">"/lrn/lisp"</span>)
  (<span style="color: #483d8b;">:render-method</span> (make-instance 'orgmode-handler))
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname <span style="color: #483d8b;">:directory</span> '(<span style="color: #483d8b;">:relative</span> <span style="color: #8b2252;">"www/lrn/lisp"</span>))
                    *base-dir*)))

(restas:mount-module -lrn/java- (#<span style="color: #483d8b;">:restas.directory-publisher</span>)
  (<span style="color: #483d8b;">:url</span> <span style="color: #8b2252;">"/lrn/java"</span>)
  (<span style="color: #483d8b;">:render-method</span> (make-instance 'orgmode-handler))
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname <span style="color: #483d8b;">:directory</span> '(<span style="color: #483d8b;">:relative</span> <span style="color: #8b2252;">"www/lrn/java"</span>))
                    *base-dir*)))

(restas:mount-module -lrn/crypto- (#<span style="color: #483d8b;">:restas.directory-publisher</span>)
  (<span style="color: #483d8b;">:url</span> <span style="color: #8b2252;">"/lrn/crypto"</span>)
  (<span style="color: #483d8b;">:render-method</span> (make-instance 'orgmode-handler))
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname <span style="color: #483d8b;">:directory</span> '(<span style="color: #483d8b;">:relative</span> <span style="color: #8b2252;">"www/lrn/crypto"</span>))
                    *base-dir*)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-10-5" class="outline-3">
<h3 id="sec-10-5">Маршруты страниц</h3>
<div class="outline-text-3" id="text-10-5">
<p>
Для всех остальных страниц маршруты определены напрямую, так, чтобы ведомый слэш не
приводил к появляению 404-ой ошибки:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="route_pages">(<span style="color: #a020f0;">in-package</span> <span style="color: #483d8b;">:rigidus</span>)

(<span style="color: #a020f0;">restas:define-route</span> index (<span style="color: #8b2252;">"/"</span>)
  (enobler (translate-logical-pathname <span style="color: #8b2252;">"org:publish;index"</span>)))

(<span style="color: #a020f0;">restas:define-route</span> index.html (<span style="color: #8b2252;">"/index.html"</span>)
  (enobler (translate-logical-pathname <span style="color: #8b2252;">"org:publish;index"</span>)))

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">def/route</span> (name param <span style="color: #228b22;">&amp;body</span> body)
  `(<span style="color: #a020f0;">progn</span>
     (<span style="color: #a020f0;">restas:define-route</span> ,name ,param
       ,@body)
     (<span style="color: #a020f0;">restas:define-route</span>
         ,(intern (concatenate 'string (symbol-name name) <span style="color: #8b2252;">"/"</span>))
         ,(cons (concatenate 'string (car param) <span style="color: #8b2252;">"/"</span>) (cdr param))
       ,@body)
     (<span style="color: #a020f0;">restas:define-route</span>
         ,(intern (concatenate 'string (symbol-name name) <span style="color: #8b2252;">".html"</span>))
         ,(cons (concatenate 'string (car param) <span style="color: #8b2252;">".html"</span>) (cdr param))
       ,@body)))

(def/route research (<span style="color: #8b2252;">"research"</span>)
  (enobler (translate-logical-pathname <span style="color: #8b2252;">"org:publish;research"</span>)))

(def/route slides (<span style="color: #8b2252;">"slides"</span>)
  (enobler (translate-logical-pathname <span style="color: #8b2252;">"org:publish;slides"</span>)))

(def/route projects (<span style="color: #8b2252;">"projects"</span>)
  (enobler (translate-logical-pathname <span style="color: #8b2252;">"org:publish;projects"</span>)))
</pre>
</div>
</div>
</div>
</div>
</div>
</body>
</html>
