<!DOCTYPE html>
<html>
<head>
<title></title>
<meta  charset="utf-8">
<meta  name="generator" content="Org-mode">
<meta  name="author" content="rigidus">
<link href="/css/style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="content">
<h1 class="title"></h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#unnumbered-1">План работ</a></li>
<li><a href="#unnumbered-2">Самовычисляемые формы</a></li>
<li><a href="#unnumbered-3">Встроенные функции арифметики</a></li>
<li><a href="#unnumbered-4">Цитирование</a></li>
<li><a href="#unnumbered-5">Работа с CONS-ячейками</a></li>
<li><a href="#unnumbered-6">NULL-предикат</a></li>
<li><a href="#unnumbered-7">Условное выполнение IF</a></li>
<li><a href="#unnumbered-8">COND</a></li>
<li><a href="#unnumbered-9">PROGN</a></li>
<li><a href="#unnumbered-10">PRINT</a></li>
<li><a href="#unnumbered-11">LIST</a></li>
<li><a href="#unnumbered-12">Вычисление символов</a></li>
<li><a href="#unnumbered-13">LET</a></li>
<li><a href="#unnumbered-14">LET*</a></li>
<li><a href="#unnumbered-15">LAMBDA</a></li>
<li><a href="#unnumbered-16"><span class="todo nilTODO">TODO</span> AND</a></li>
<li><a href="#unnumbered-17"><span class="todo nilTODO">TODO</span> OR</a></li>
<li><a href="#unnumbered-18">Итоги</a></li>
</ul>
</div>
</div>

<div id="outline-container-unnumbered-1" class="outline-2">
<h2 id="unnumbered-1">План работ</h2>
<div class="outline-text-2" id="text-unnumbered-1">
<p>
Теперь добавим к нашей реализации окружения. Для этого, у <code>myeval</code> появляется еще один
параметр <code>env</code>. В параметре <code>env</code> передается окружение, которое у нас будет реализовано
как ассоциативный список вида:
</p>

<div class="org-src-container">

<pre class="src src-lisp">((a . 1) (b . 42) (c . somesymbol))
</pre>
</div>

<p>
Таким образом, <code>myeval</code> становится таким:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">myeval</span> (lst env)
  (<span style="color: #af00ff;">cond</span>
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1050;&#1072;&#1082;&#1080;&#1077;-&#1090;&#1086; &#1076;&#1077;&#1081;&#1089;&#1090;&#1074;&#1080;&#1103; &#1074; &#1079;&#1072;&#1074;&#1080;&#1089;&#1080;&#1084;&#1086;&#1089;&#1090;&#1080; &#1086;&#1090; &#1090;&#1086;&#1075;&#1086; &#1082;&#1072;&#1082;&#1072;&#1103; &#1092;&#1086;&#1088;&#1084;&#1072;</span>
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">...</span>
    (t (<span style="color: #ff0000; font-weight: bold;">error</span> 'unknown-form))))
</pre>
</div>

<p>
Соотвественно все вызовы <code>myeval</code> изменяются, чтобы использовать <code>env</code>
</p>
</div>
</div>

<div id="outline-container-unnumbered-2" class="outline-2">
<h2 id="unnumbered-2">Самовычисляемые формы</h2>
<div class="outline-text-2" id="text-unnumbered-2">
<p>
Здесь ничего не меняется
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="number_1">((null lst)                  nil)
((numberp lst)               lst)
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-3" class="outline-2">
<h2 id="unnumbered-3">Встроенные функции арифметики</h2>
<div class="outline-text-2" id="text-unnumbered-3">
<p>
Вызов <code>my-eval</code> использует дополнительный параметр <code>env</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="ariph_1">((equal (car lst) '+)        (+ (myeval (cadr lst) env)
                                (myeval (caddr lst) env)))
((equal (car lst) '*)        (* (myeval (cadr lst) env)
                                (myeval (caddr lst) env)))
</pre>
</div>

<p>
К старым тестам (изменным, чтобы принимать пустое окружение) добавляем новые, которые
используют окружение, которое пока мы формируем вручную
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="ariph_1_test">(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 7 (myeval 7 nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(+ 1 2) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 21 (myeval '(* (+ 1 2) (+ 3 4)) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval 'a '((a . 2)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 47 (myeval '(+ a b) '((a . 45) (b . 2)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-4" class="outline-2">
<h2 id="unnumbered-4">Цитирование</h2>
<div class="outline-text-2" id="text-unnumbered-4">
<p>
Без изменений
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="quote_1">((equal (car lst) 'quote)    (cadr lst))
</pre>
</div>

<p>
Без изменений
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="quote_1_test">(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(+ 1 2) (myeval '(quote (+ 1 2)) nil)))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-5" class="outline-2">
<h2 id="unnumbered-5">Работа с CONS-ячейками</h2>
<div class="outline-text-2" id="text-unnumbered-5">
<p>
Добавляем параметр
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="car_cdr_cons_1">((equal (car lst) 'car)      (car (myeval (cadr lst) env)))
((equal (car lst) 'cdr)      (cdr (myeval (cadr lst) env)))
((equal (car lst) 'cons)     (cons (myeval (cadr lst) env)
                                   (myeval (caddr lst) env)))
</pre>
</div>

<p>
Добавляем тесты, которые работают с cons-ячейками, полученными из окружения
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="car_cdr_cons_1_test">(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 2) (myeval '(cons 1 2) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '((1 . 2) 3 . 4) (myeval '(cons (cons 1 2) (cons 3 4)) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(car (cons 2 3)) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(cdr (cons 2 3)) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 2) (myeval '(car (cons (cons 1 2) (cons 3 4))) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 . 4) (myeval '(cdr (cons (cons 1 2) (cons 3 4))) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (myeval '(car a) '((a . (1 . 2))))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(cdr a) '((a . (1 . 2))))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(car b) '((a . (1 . 2)) (b . (3 . 4))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-6" class="outline-2">
<h2 id="unnumbered-6">NULL-предикат</h2>
<div class="outline-text-2" id="text-unnumbered-6">
<p>
Без изменений
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="null_1">((equal (car lst) 'null)     (null (myeval (cadr lst) env)))
</pre>
</div>

<p>
Добавляем тесты, проверящие символ в окружении, равный nil и не nil
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="null_1_test">(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal T (myeval '(null ()) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal T (myeval '(null a)) '((a . ()))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal NIL (myeval '(null a)) '((a . 1))))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-7" class="outline-2">
<h2 id="unnumbered-7">Условное выполнение IF</h2>
<div class="outline-text-2" id="text-unnumbered-7">
<p>
Без изменений
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="if_1">((equal (car lst) 'if)       (<span style="color: #af00ff;">if</span> (myeval (cadr lst) env)
                                 (myeval (caddr lst) env)
                                 (myeval (cadddr lst) env)))
</pre>
</div>

<p>
Добавляем тесты, где условие вычисляется с использованием окружения
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="if_1_test">(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(<span style="color: #af00ff;">if</span> () 1 2) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (myeval '(<span style="color: #af00ff;">if</span> (null ()) 1 2) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(<span style="color: #af00ff;">if</span> a 1 2) '((a . ())))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (myeval '(<span style="color: #af00ff;">if</span> a 1 2) '((a . 1)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-8" class="outline-2">
<h2 id="unnumbered-8">COND</h2>
<div class="outline-text-2" id="text-unnumbered-8">
<p>
Без изменений
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="evcond_1">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evcond</span> (lst env)
  (<span style="color: #af00ff;">cond</span> ((null lst)               nil)
        ((myeval (caar lst) env)  (myeval (cadar lst) env))
        (t                        (evcond (cdr lst) env))))
</pre>
</div>

<p>
Без изменений
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="cond_1">((equal (car lst) 'cond)     (evcond (cdr lst) env))
</pre>
</div>

<p>
Добавляем тесты для окружений
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="cond_1_test">(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(<span style="color: #af00ff;">cond</span>
                           (() 1)
                           (1 2))
                         nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(<span style="color: #af00ff;">cond</span>
                         (a 1)
                         (b 2))
                       '((a . ()) (b . 1)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (myeval '(<span style="color: #af00ff;">cond</span>
                           (a 1)
                           (b 2))
                         '((a . 1) (b . ())))))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-9" class="outline-2">
<h2 id="unnumbered-9">PROGN</h2>
<div class="outline-text-2" id="text-unnumbered-9">
<p>
Без изменений
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="evprogn_1">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evprogn</span> (lst env)
  (<span style="color: #af00ff;">cond</span> ((null lst)        nil)
        ((null (cdr lst))  (myeval (car lst) env))
        (t                 (myeval (car lst) env)
                           (evprogn (cdr lst) env))))
</pre>
</div>

<p>
Без изменений
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="progn_1">((equal (car lst) 'progn)    (evprogn (cdr lst) env))
</pre>
</div>

<p>
Добавляем тесты в окружении
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="progn_1_test">(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(<span style="color: #af00ff;">progn</span> 1 2 3) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(<span style="color: #af00ff;">progn</span> a b c) '((a . 1) (b . 2) (c . 3)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-10" class="outline-2">
<h2 id="unnumbered-10">PRINT</h2>
<div class="outline-text-2" id="text-unnumbered-10">
<p>
Без изменений
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="print_1">((equal (car lst) 'print)    (print (myeval (cadr lst)  env)))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-11" class="outline-2">
<h2 id="unnumbered-11">LIST</h2>
<div class="outline-text-2" id="text-unnumbered-11">
<p>
Без изменений
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="evlis_1">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evlis</span> (lst env)
  (<span style="color: #af00ff;">cond</span> ((null lst) nil)
        (t (cons (myeval (car lst) env)
                 (evlis (cdr lst) env)))))
</pre>
</div>

<p>
Добавляем тесты в окружении
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="evlis_1_test">(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 6 42)
               (evlis '((+ 1 2) (* 2 3) 42) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 6 42)
               (evlis '((+ a b) (* b c) 42) '((a . 1) (b . 2) (c . 3) (d . 4)))))
</pre>
</div>

<p>
LIST определяем почти без изменений:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="list_1">((equal (car lst) 'list)     (evlis (cdr lst) env))
</pre>
</div>

<p>
Протестируем <code>list</code> (добавляя тесты в окружении)
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="list_1_test">(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 6 42)
               (myeval '(list (+ 1 2) (* 2 3) 42) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 6 42)
               (myeval '(list (+ a b) (* b c) 42)
                       '((a . 1) (b . 2) (c . 3) (d . 4)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-12" class="outline-2">
<h2 id="unnumbered-12">Вычисление символов</h2>
<div class="outline-text-2" id="text-unnumbered-12">
<p>
С этого момента мы начинаем расширять возможности интерпретатора.
</p>

<p>
Если мы встречаем символ, то мы должны найти его в нашем окружении. Мы можем достичь
этого следующим образом:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="symb_1">((symbolp lst)               (cdr (assoc lst env)))
</pre>
</div>

<p>
Важно поместить этот кусок ближе к началу <code>myeval</code>, чтобы избежать попыток выполнять
над символом те операции, которые выполняются над списковыми формами.
</p>

<p>
Протестируем
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="symb_1_test">(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 6 (myeval 'b '((a . 3) (b . 6)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-13" class="outline-2">
<h2 id="unnumbered-13">LET</h2>
<div class="outline-text-2" id="text-unnumbered-13">
<p>
Теперь мы можем заняться более сложной частью - работой с окружениями. Чтобы добавить
переменную в окружение нам понадобятся вспомогательных функции. Первая из них: EVLIS
(Evaluate List) уже у нас есть (мы определили ее в разделе, где определен LIST).
</p>

<p>
Вторая вспомогательная функция: PAIRLIS. Мы будем использовать ее для работы с
окружениями. Она принимает список ключей <code>lst1</code>, список значений <code>lst2</code> и ассоциативный
список результатов <code>alist</code>. В процессе своей работы из первых двух списков она
формирует пары "ключ-значение" и добавляет их в <code>alist</code>. Мы можем добавлять пары в
начало или в в конец <code>alist</code>. Этот вариант добавляет пары в конец:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="mypairlis_example">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">mypairlis</span> (lst1 lst2 alist)
 (<span style="color: #af00ff;">cond</span> ((and (null lst1) (null lst2))  alist)
       ((or  (null lst1) (null lst2))  (<span style="color: #ff0000; font-weight: bold;">error</span> 'mypairlis-error))
       (t                               (mypairlis (cdr lst1)
                                                   (cdr lst2)
                                                   (cons (cons (car lst1)
                                                               (car lst2))
                                                         alist)))))
</pre>
</div>

<p>
Но мы остановились на варианте, который добавляет пары в начало. Почему? Из-за различия
в семантике, которое проявляется, если разрешены дубли в lambda-list. Если дубли
запрещены, то неважно, какой <code>pairlis</code> использовать. Хотя, вариант с хвостовой
рекурсией будет эффективнее.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="mypairlis_1">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">mypairlis</span> (lst1 lst2 alist)
  (<span style="color: #af00ff;">cond</span> ((and (null lst1) (null lst2))  alist)
        ((or  (null lst1) (null lst2))  (<span style="color: #ff0000; font-weight: bold;">error</span> 'mypairlis-error))
        (t                              (cons (cons (car lst1)
                                                    (car lst2))
                                              (mypairlis (cdr lst1)
                                                         (cdr lst2)
                                                         alist)))))
</pre>
</div>

<p>
Протестируем <code>mypairlis</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="mypairlis_1_test">(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(( a . 1) (b . 2) ( c . 3) (z . 6) (y . 77))
               (mypairlis '(a b c) '(1 2 3) '((z . 6) (y . 77)))))
</pre>
</div>

<p>
Имея эти функции мы можем определить LET:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="let_1">((equal (car lst) 'let)      (evprogn (cddr lst) <span style="color: #af0000;">; implicit progn</span>
                                      (pairlis (mapcar #'car
                                                       (car (cdr lst)))
                                               (evlis (mapcar #'cadr
                                                              (car (cdr lst)))
                                                      env)
                                               env)))
</pre>
</div>

<p>
и проверить его:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="let_1_test">(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 2) (myeval '(<span style="color: #af00ff;">let</span> ((a 1)
                                       (b 2))
                                  (cons a b)) nil)))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-14" class="outline-2">
<h2 id="unnumbered-14">LET*</h2>
<div class="outline-text-2" id="text-unnumbered-14">
<p>
Определение LET* потребует одну дополнительную функцию, которую назовем EVLETSTAR. Она
принимает три аргумента. Первый, <code>varpairs</code>, представляет собой пары "ключ-значение",
которые на каждом шаге по одной будут добавлены в окружение <code>env</code>. Второй параметр,
<code>EXP</code>, представляет собой тело выражения, которое должно быть вычислено, когда все
varpairs будут добавлены в окончательное окружение.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="evletstar_1">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evletstar</span> (varpairs exp env)
  (<span style="color: #af00ff;">cond</span> ((null varpairs)  (myeval exp env))
        (t                (evletstar (cdr varpairs)
                                     exp
                                     (cons (cons (caar varpairs)
                                                 (myeval (cadar varpairs) env))
                                           env)))))
</pre>
</div>

<p>
Теперь мы можем определить LET*:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="letstar_1">((equal (car lst) 'let*)     (evletstar (cadr lst)
                                        (caddr lst)
                                        env))
</pre>
</div>

<p>
и протестировать его:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="letstar_1_test">(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 1 . 2) (myeval '(<span style="color: #af00ff;">let*</span> ((a 1)
                                          (b 2)
                                          (c (+ a b)))
                                    (cons c (cons a b))) nil)))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-15" class="outline-2">
<h2 id="unnumbered-15">LAMBDA</h2>
<div class="outline-text-2" id="text-unnumbered-15">
<p>
Последняя форма, которую мы реализуем - LAMBDA. В нашем интерпретаторе она вычисляется
при вызове, являясь первым аргументом вычисляемого списка: <code>((lambda (x) (cons x x))
42)</code> Кроме того, LAMBDA формирует свое окружение из своих параметров:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="lambda_1">((equal (caar lst) 'lambda)  (myeval (car (cddar lst))
                                     (pairlis (cadar lst)
                                              (evlis (cdr lst) env)
                                              env)))
</pre>
</div>

<p>
Проверим работу LAMBDA:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="lambda_1_test">(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(42 . 42) (myeval '((<span style="color: #af00ff;">lambda</span> (x)
                                      (cons x x))
                                    42) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(42 . 17) (myeval '((<span style="color: #af00ff;">lambda</span> (x y)
                                      (cons x y))
                                    42 17) nil)))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-16" class="outline-2">
<h2 id="unnumbered-16"><span class="todo TODO">TODO</span> AND</h2>
</div>
<div id="outline-container-unnumbered-17" class="outline-2">
<h2 id="unnumbered-17"><span class="todo TODO">TODO</span> OR</h2>
</div>
<div id="outline-container-unnumbered-18" class="outline-2">
<h2 id="unnumbered-18">Итоги</h2>
<div class="outline-text-2" id="text-unnumbered-18">
<p>
Соберем простой интерпретатор из <code>myeval</code> и вспомогательных функций и запишем его файл:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="simple">&lt;&lt;evcond_1&gt;&gt;
&lt;&lt;evprogn_1&gt;&gt;
&lt;&lt;evlis_1&gt;&gt;
&lt;&lt;mypairlis_1&gt;&gt;
&lt;&lt;evletstar_1&gt;&gt;
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">myeval</span> (lst env)
  (<span style="color: #af00ff;">cond</span>
    &lt;&lt;number_1&gt;&gt;
    &lt;&lt;symb_1&gt;&gt;
    &lt;&lt;ariph_1&gt;&gt;
    &lt;&lt;quote_1&gt;&gt;
    &lt;&lt;car_cdr_cons_1&gt;&gt;
    &lt;&lt;null_1&gt;&gt;
    &lt;&lt;if_1&gt;&gt;
    &lt;&lt;cond_1&gt;&gt;
    &lt;&lt;progn_1&gt;&gt;
    &lt;&lt;print_1&gt;&gt;
    &lt;&lt;list_1&gt;&gt;
    &lt;&lt;let_1&gt;&gt;
    &lt;&lt;letstar_1&gt;&gt;
    &lt;&lt;lambda_1&gt;&gt;
    (t (<span style="color: #ff0000; font-weight: bold;">error</span> 'unknown-form))))

&lt;&lt;symb_1_test&gt;&gt;
&lt;&lt;ariph_1_test&gt;&gt;
&lt;&lt;quote_1_test&gt;&gt;
&lt;&lt;car_cdr_cons_1_test&gt;&gt;
&lt;&lt;if_1_test&gt;&gt;
&lt;&lt;cond_1_test&gt;&gt;
&lt;&lt;evlis_1_test&gt;&gt;
&lt;&lt;list_1_test&gt;&gt;
&lt;&lt;mypairlis_1_test&gt;&gt;
&lt;&lt;let_1_test&gt;&gt;
&lt;&lt;letstar_1_test&gt;&gt;
&lt;&lt;lambda_1_test&gt;&gt;
</pre>
</div>

<p>
Мы должны получить следующий результат:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evcond</span> (lst env)
  (<span style="color: #af00ff;">cond</span> ((null lst)               nil)
        ((myeval (caar lst) env)  (myeval (cadar lst) env))
        (t                        (evcond (cdr lst) env))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evprogn</span> (lst env)
  (<span style="color: #af00ff;">cond</span> ((null lst)        nil)
        ((null (cdr lst))  (myeval (car lst) env))
        (t                 (myeval (car lst) env)
                           (evprogn (cdr lst) env))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evlis</span> (lst env)
  (<span style="color: #af00ff;">cond</span> ((null lst) nil)
        (t (cons (myeval (car lst) env)
                 (evlis (cdr lst) env)))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">mypairlis</span> (lst1 lst2 alist)
  (<span style="color: #af00ff;">cond</span> ((and (null lst1) (null lst2))  alist)
        ((or  (null lst1) (null lst2))  (<span style="color: #ff0000; font-weight: bold;">error</span> 'mypairlis-error))
        (t                              (cons (cons (car lst1)
                                                    (car lst2))
                                              (mypairlis (cdr lst1)
                                                         (cdr lst2)
                                                         alist)))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evletstar</span> (varpairs exp env)
  (<span style="color: #af00ff;">cond</span> ((null varpairs)  (myeval exp env))
        (t                (evletstar (cdr varpairs)
                                     exp
                                     (cons (cons (caar varpairs)
                                                 (myeval (cadar varpairs) env))
                                           env)))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">myeval</span> (lst env)
  (<span style="color: #af00ff;">cond</span>
    ((null lst)                  nil)
    ((numberp lst)               lst)
    ((symbolp lst)               (cdr (assoc lst env)))
    ((equal (car lst) '+)        (+ (myeval (cadr lst) env)
                                    (myeval (caddr lst) env)))
    ((equal (car lst) '*)        (* (myeval (cadr lst) env)
                                    (myeval (caddr lst) env)))
    ((equal (car lst) 'quote)    (cadr lst))
    ((equal (car lst) 'car)      (car (myeval (cadr lst) env)))
    ((equal (car lst) 'cdr)      (cdr (myeval (cadr lst) env)))
    ((equal (car lst) 'cons)     (cons (myeval (cadr lst) env)
                                       (myeval (caddr lst) env)))
    ((equal (car lst) 'null)     (null (myeval (cadr lst) env)))
    ((equal (car lst) 'if)       (<span style="color: #af00ff;">if</span> (myeval (cadr lst) env)
                                     (myeval (caddr lst) env)
                                     (myeval (cadddr lst) env)))
    ((equal (car lst) 'cond)     (evcond (cdr lst) env))
    ((equal (car lst) 'progn)    (evprogn (cdr lst) env))
    ((equal (car lst) 'print)    (print (myeval (cadr lst)  env)))
    ((equal (car lst) 'list)     (evlis (cdr lst) env))
    ((equal (car lst) 'let)      (evprogn (cddr lst) <span style="color: #af0000;">; implicit progn</span>
                                          (pairlis (mapcar #'car
                                                           (car (cdr lst)))
                                                   (evlis (mapcar #'cadr
                                                                  (car (cdr lst)))
                                                          env)
                                                   env)))
    ((equal (car lst) 'let*)     (evletstar (cadr lst)
                                            (caddr lst)
                                            env))
    ((equal (caar lst) 'lambda)  (myeval (car (cddar lst))
                                         (pairlis (cadar lst)
                                                  (evlis (cdr lst) env)
                                                  env)))
    (t (<span style="color: #ff0000; font-weight: bold;">error</span> 'unknown-form))))

(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 6 (myeval 'b '((a . 3) (b . 6)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 7 (myeval 7 nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(+ 1 2) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 21 (myeval '(* (+ 1 2) (+ 3 4)) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval 'a '((a . 2)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 47 (myeval '(+ a b) '((a . 45) (b . 2)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(+ 1 2) (myeval '(quote (+ 1 2)) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 2) (myeval '(cons 1 2) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '((1 . 2) 3 . 4) (myeval '(cons (cons 1 2) (cons 3 4)) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(car (cons 2 3)) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(cdr (cons 2 3)) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 2) (myeval '(car (cons (cons 1 2) (cons 3 4))) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 . 4) (myeval '(cdr (cons (cons 1 2) (cons 3 4))) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (myeval '(car a) '((a . (1 . 2))))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(cdr a) '((a . (1 . 2))))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(car b) '((a . (1 . 2)) (b . (3 . 4))))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(<span style="color: #af00ff;">if</span> () 1 2) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (myeval '(<span style="color: #af00ff;">if</span> (null ()) 1 2) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(<span style="color: #af00ff;">if</span> a 1 2) '((a . ())))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (myeval '(<span style="color: #af00ff;">if</span> a 1 2) '((a . 1)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(<span style="color: #af00ff;">cond</span>
                           (() 1)
                           (1 2))
                         nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(<span style="color: #af00ff;">cond</span>
                           (a 1)
                           (b 2))
                         '((a . ()) (b . 1)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (myeval '(<span style="color: #af00ff;">cond</span>
                           (a 1)
                           (b 2))
                         '((a . 1) (b . ())))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 6 42)
               (evlis '((+ 1 2) (* 2 3) 42) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 6 42)
               (evlis '((+ a b) (* b c) 42) '((a . 1) (b . 2) (c . 3) (d . 4)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 6 42)
               (myeval '(list (+ 1 2) (* 2 3) 42) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 6 42)
               (myeval '(list (+ a b) (* b c) 42)
                       '((a . 1) (b . 2) (c . 3) (d . 4)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(( a . 1) (b . 2) ( c . 3) (z . 6) (y . 77))
               (mypairlis '(a b c) '(1 2 3) '((z . 6) (y . 77)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 2) (myeval '(<span style="color: #af00ff;">let</span> ((a 1)
                                       (b 2))
                                  (cons a b)) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 1 . 2) (myeval '(<span style="color: #af00ff;">let*</span> ((a 1)
                                          (b 2)
                                          (c (+ a b)))
                                    (cons c (cons a b))) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(42 . 42) (myeval '((<span style="color: #af00ff;">lambda</span> (x)
                                      (cons x x))
                                    42) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(42 . 17) (myeval '((<span style="color: #af00ff;">lambda</span> (x y)
                                      (cons x y))
                                    42 17) nil)))
</pre>
</div>
</div>
</div>
</div>
</body>
</html>
